version: 2.1

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
orbs:
  ruby: circleci/ruby@1.2.0

jobs:
  build:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run:
          name: Configure key.properties
          command: |
            printf "
            keyAlias=%s
            keyPassword=%s
            storeFile=%s
            storePassword=%s
            " $RELEASE_KEY_ALIAS $RELEASE_KEY_PASSWORD "$(pwd)/android/keystore" $RELEASE_STORE_PASSWORD > android/key.properties
      - run: echo $GOOGLE_PLAY_KEY > google-play.json
      - run: echo $APP_STORE_CONNECT_API_KEY_KEY > appstore-connect-api-key.p8
      - run: echo $BASE64_KEYSTORE | base64 -d | tee keystore android/keystore
      - run: flutter channel
      - run: flutter doctor
      - run: gem install fastlane
      - run: fastlane run app_store_connect_api_key key_id:"$APP_STORE_CONNECT_API_KEY_KEY_ID"  issuer_id:"$APP_STORE_CONNECT_API_KEY_ISSUER_ID"  key_content:"$APP_STORE_CONNECT_API_KEY_KEY" is_key_content_base64:true
#      - run:
#          name: fastlane
#          command: fastlane run validate_play_store_json_key json_key_data:"$GOOGLE_PLAY_KEY" --verbose
#      - run: flutter build apk
